#!/usr/bin/env bash
set -euo pipefail

# Find gcovr
GCOVR_EXEC=$(command -v gcovr || true)
if [[ -z "$GCOVR_EXEC" ]]; then
    echo "Error: gcovr not found in PATH"
    exit 1
fi

echo "==> Capturing coverage data..."
mkdir -p "@COVERAGE_REPORT_DIR@/html"
mkdir -p "@COVERAGE_REPORT_DIR@/xml"
$GCOVR_EXEC \
    -d "@CMAKE_BINARY_DIR@" \
    -r "@CMAKE_SOURCE_DIR@" \
    --filter "@CMAKE_SOURCE_DIR@/src/core/.*" \
    --filter "@CMAKE_SOURCE_DIR@/include/core/.*" \
    --filter "@CMAKE_SOURCE_DIR@/src/ai/.*" \
    --filter "@CMAKE_SOURCE_DIR@/include/ai/.*" \
    --html-details "@COVERAGE_REPORT_DIR@/html/coverage.html" \
    --xml "@COVERAGE_REPORT_DIR@/xml/coverage.xml" \
    --txt-metric branch \
    --exclude-throw-branches \
    --sort uncovered-percent \
    --print-summary

echo "Coverage report generated:"
echo "  HTML: @COVERAGE_REPORT_DIR@/html/coverage.html"
echo "  XML : @COVERAGE_REPORT_DIR@/xml/coverage.xml"
