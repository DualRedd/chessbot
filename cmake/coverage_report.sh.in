#!/usr/bin/env bash
set -euo pipefail

# Find gcovr
GCOVR_EXEC=$(command -v gcovr || true)
if [[ -z "$GCOVR_EXEC" ]]; then
    echo "Error: gcovr not found in PATH"
    exit 1
fi

echo "==> Cleaning old coverage data..."
find "@CMAKE_BINARY_DIR@" \
    -name "*.gcda" \
    -type f -delete \

echo "==> Running tests..."
ctest --test-dir "@CMAKE_BINARY_DIR@" \
    --output-on-failure

echo "==> Capturing coverage data..."
mkdir -p "@COVERAGE_DIR@/html"
mkdir -p "@COVERAGE_DIR@/xml"
$GCOVR_EXEC \
    -r "@CMAKE_SOURCE_DIR@" \
    --filter "@CMAKE_SOURCE_DIR@/src/.*" \
    --html-details "@COVERAGE_DIR@/html/coverage.html" \
    --xml "@COVERAGE_DIR@/xml/coverage.xml" \
    --branches \
    --exclude-throw-branches \
    --print-summary

echo "Coverage report generated:"
echo "  HTML: @COVERAGE_DIR@/html/coverage.html"
echo "  XML : @COVERAGE_DIR@/xml/coverage.xml"
