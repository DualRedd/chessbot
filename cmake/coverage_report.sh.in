#!/usr/bin/env bash
set -euo pipefail

echo "==> Cleaning old coverage data..."
find "@CMAKE_BINARY_DIR@" \
    -name "*.gcda" \
    -type f -delete \

echo "==> Running tests..."
ctest --test-dir "@CMAKE_BINARY_DIR@" \
    --output-on-failure

echo "==> Capturing coverage data..."
@LCOV_EXEC@ --capture \
            --directory @CMAKE_BINARY_DIR@ \
            --output-file @COVERAGE_DIR@/coverage_raw.info \
            --rc lcov_branch_coverage=1 \
            --quiet 2>&1 | grep -v "Subroutine" || true
@LCOV_EXEC@ --remove @COVERAGE_DIR@/coverage_raw.info @COVERAGE_EXCLUDE_QUOTED@ \
            --output-file @COVERAGE_DIR@/coverage_raw.info \
            --rc lcov_branch_coverage=1 \
            --quiet

echo "==> Filtering branching data..."
@Python3_EXECUTABLE@ @COVERAGE_DIR@/coverage_filter.py \
                    @COVERAGE_DIR@/coverage_raw.info \
                    @COVERAGE_DIR@/coverage.info

echo "==> Generating HTML report..."
@GENHTML_EXEC@ @COVERAGE_DIR@/coverage.info \
            --output-directory @COVERAGE_DIR@/html \
            --rc lcov_branch_coverage=1 \
            --quiet
echo "Coverage report generated at: @COVERAGE_DIR@/html/index.html"

echo "==> Coverage summary:"
@LCOV_EXEC@ --summary @COVERAGE_DIR@/coverage.info \
            --rc lcov_branch_coverage=1
